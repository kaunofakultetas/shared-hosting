# Database Schema

This document describes the SQLite database schema, table relationships, and data access patterns used in the App Hosting Platform.

---

## 1. Database Overview

### 1.1 Database Technology

| Property | Value |
|----------|-------|
| Engine | SQLite 3 |
| Location | `_DATA/control-backend/database.db` |
| Access | Single-writer, multiple-reader |
| Backup | File copy when container stopped |

### 1.2 Design Principles

- **Simplicity**: Single SQLite file for all data
- **Soft Deletes**: Virtual servers marked as deleted, not removed
- **JSON Aggregation**: Complex queries use SQLite JSON functions
- **Timestamps**: All tables include creation/update timestamps

---

## 2. Entity Relationship Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                    ENTITY RELATIONSHIP DIAGRAM                      │
│                                                                     │
│  ┌─────────────────────┐         ┌─────────────────────┐            │
│  │   System_Users      │         │ System_Registration │            │
│  │                     │         │      Codes          │            │
│  │ ID (PK)             │◄────────│ UserID (FK)         │            │
│  │ Email (UNIQUE)      │    1:1  │ Code (UNIQUE)       │            │
│  │ Password            │         │ ValidUntil          │            │
│  │ Admin               │         └─────────────────────┘            │
│  │ Enabled             │                                            │
│  │ LastLogin           │         ┌─────────────────────┐            │
│  └─────────┬───────────┘         │System_RecentActivity│            │
│            │                     │                     │            │
│            │ 1:N                 │ ID (PK)             │            │
│            │                     │ UserID (FK)         │◄───────────┤
│            ▼                     │ Message             │            │
│  ┌─────────────────────┐         │ Time                │            │
│  │Hosting_VirtualServers         └─────────────────────┘            │
│  │                     │                                            │
│  │ ID (PK)             │                                            │
│  │ OwnerID (FK)        │                                            │
│  │ Name                │                                            │
│  │ Enabled             │                                            │
│  │ Deleted             │                                            │
│  │ CreatedAt           │                                            │
│  │ UpdatedAt           │                                            │
│  └─────────┬───────────┘                                            │
│            │                                                        │
│            │ 1:N                                                    │
│            │                                                        │
│  ┌─────────▼───────────┐         ┌─────────────────────┐            │
│  │Hosting_DomainNames  │         │Hosting_Docker       │            │
│  │                     │         │    Containers       │            │
│  │ ID (PK)             │         │                     │            │
│  │ VirtualServerID (FK)│         │ DockerID            │            │
│  │ DomainName (UNIQUE) │         │ ParentServerID (FK) │◄───────────┤
│  │ IsCloudflare        │         │ Image               │            │
│  │ SSL                 │         │ Names               │            │
│  └─────────────────────┘         │ State               │            │
│                                  │ Status              │            │
│                                  │ ...                 │            │
│                                  └─────────────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. Table Definitions

### 3.1 System_Users

Stores user accounts and authentication data.

```sql
CREATE TABLE System_Users (
    ID          INTEGER NOT NULL UNIQUE PRIMARY KEY AUTOINCREMENT,
    Email       TEXT NOT NULL UNIQUE,
    Password    TEXT NOT NULL,          -- bcrypt hash
    Admin       INTEGER DEFAULT 0,       -- 0=user, 1=admin
    Enabled     INTEGER NOT NULL DEFAULT 0,
    LastLogin   TEXT NOT NULL DEFAULT ''
);
```

**Sample Data**:
| ID | Email | Password | Admin | Enabled | LastLogin |
|----|-------|----------|-------|---------|-----------|
| 1 | admin@admin.com | $2b$12$... | 1 | 1 | 2025-12-08 10:30:00 |
| 2 | user@example.com | $2b$12$... | 0 | 1 | 2025-12-07 15:45:00 |

---

### 3.2 System_RegistrationCodes

Stores temporary registration codes generated by admins.

```sql
CREATE TABLE System_RegistrationCodes (
    ID          INTEGER NOT NULL UNIQUE PRIMARY KEY AUTOINCREMENT,
    UserID      INTEGER NOT NULL UNIQUE,  -- Admin who created it
    Code        TEXT NOT NULL UNIQUE,      -- 8-char alphanumeric
    ValidUntil  INTEGER NOT NULL           -- Unix timestamp
);
```

**Sample Data**:
| ID | UserID | Code | ValidUntil |
|----|--------|------|------------|
| 1 | 1 | ABC12345 | 1733666400 |

**Notes**:
- One code per admin at a time
- Codes expire after 30 minutes
- Expired codes auto-deleted on GET

---

### 3.3 Hosting_VirtualServers

Stores virtual server metadata.

```sql
CREATE TABLE Hosting_VirtualServers (
    ID          INTEGER NOT NULL UNIQUE PRIMARY KEY,  -- Not AUTOINCREMENT, matches container ID
    OwnerID     INTEGER NOT NULL,
    Name        TEXT NOT NULL DEFAULT '',
    Enabled     INTEGER NOT NULL DEFAULT 1,
    Deleted     INTEGER NOT NULL DEFAULT 0,           -- Soft delete flag
    CreatedAt   TEXT NOT NULL,
    UpdatedAt   TEXT NOT NULL
);

-- Special entry for host-level containers
INSERT INTO Hosting_VirtualServers VALUES (0, 0, 'HOST', 1, 0, '', '');
```

**Sample Data**:
| ID | OwnerID | Name | Enabled | Deleted | CreatedAt | UpdatedAt |
|----|---------|------|---------|---------|-----------|-----------|
| 0 | 0 | HOST | 1 | 0 | | |
| 1 | 2 | My Web App | 1 | 0 | 2025-12-01 10:00:00 | 2025-12-08 09:00:00 |
| 2 | 2 | API Server | 0 | 0 | 2025-12-02 14:30:00 | 2025-12-07 16:00:00 |

**Notes**:
- ID 0 represents the host (for tracking host-level containers)
- Deleted servers have `Deleted=1`, not physically removed
- `Enabled` reflects running state

---

### 3.4 Hosting_DockerContainers

Stores container status information, updated by background monitor.

```sql
CREATE TABLE Hosting_DockerContainers (
    DockerID        TEXT NOT NULL,
    ParentServerID  INTEGER NOT NULL,       -- 0 = host, N = virtual server
    Command         TEXT NOT NULL,
    CreatedAt       TEXT NOT NULL,
    Image           TEXT NOT NULL,
    Labels          TEXT NOT NULL,          -- Comma-separated
    Mounts          TEXT NOT NULL,
    Names           TEXT NOT NULL,
    Networks        TEXT NOT NULL,
    Ports           TEXT NOT NULL,
    RunningFor      TEXT NOT NULL,
    Size            TEXT NOT NULL,
    State           TEXT NOT NULL,          -- running, exited, etc.
    Status          TEXT NOT NULL,
    UpdatedAt       TEXT NOT NULL,
    UNIQUE(DockerID, ParentServerID)
);
```

**Sample Data**:
| DockerID | ParentServerID | Image | Names | State | Status |
|----------|----------------|-------|-------|-------|--------|
| abc123... | 0 | hosting-dind-ubuntu | hosting-users-dind-1 | running | Up 2 hours |
| def456... | 1 | nginx:latest | web-server | running | Up 1 hour |
| ghi789... | 1 | postgres:15 | database | running | Up 1 hour |

**Notes**:
- `ParentServerID=0` means container runs on host
- `ParentServerID=N` means container runs inside virtual server N
- Stale entries (not updated in 5 min) are auto-deleted

---

### 3.5 Hosting_DomainNames

Stores domain name configurations.

```sql
CREATE TABLE Hosting_DomainNames (
    ID              INTEGER NOT NULL UNIQUE PRIMARY KEY AUTOINCREMENT,
    VirtualServerID INTEGER NOT NULL,
    DomainName      TEXT NOT NULL UNIQUE,
    IsCloudflare    INTEGER NOT NULL DEFAULT 0,
    SSL             INTEGER NOT NULL DEFAULT 0
);
```

**Sample Data**:
| ID | VirtualServerID | DomainName | IsCloudflare | SSL |
|----|-----------------|------------|--------------|-----|
| 1 | 1 | myapp.example.com | 0 | 1 |
| 2 | 1 | api.example.com | 1 | 1 |
| 3 | 2 | demo.project.org | 0 | 0 |

---

### 3.6 System_RecentActivity

Stores activity log for audit purposes.

```sql
CREATE TABLE System_RecentActivity (
    ID      INTEGER NOT NULL UNIQUE PRIMARY KEY AUTOINCREMENT,
    UserID  INTEGER NOT NULL,
    Message TEXT NOT NULL,
    Time    TEXT NOT NULL
);
```

**Sample Data**:
| ID | UserID | Message | Time |
|----|--------|---------|------|
| 1 | 1 | User admin@admin.com logged in (IP: 10.0.0.1) | 2025-12-08 10:30:00 |
| 2 | 2 | Virtual server #1 created | 2025-12-08 10:35:00 |
| 3 | 2 | Domain name "myapp.example.com" added | 2025-12-08 10:40:00 |

---

## 4. Complex Queries

### 4.1 Users List with Server Count

```sql
WITH GetUserServersCount AS (
    SELECT
        OwnerID,
        COUNT(*) AS ServerCount
    FROM
        Hosting_VirtualServers
    WHERE
        Deleted = 0
    GROUP BY OwnerID
)
SELECT
    json_group_array(
        json_object(
            'id',           System_Users.ID,
            'email',        System_Users.Email,
            'servercount',  IFNULL(GetUserServersCount.ServerCount, 0),
            'admin',        System_Users.Admin,
            'enabled',      System_Users.Enabled,
            'lastseen',     System_Users.LastLogin
        )
    ) AS UsersJSON
FROM
    System_Users
LEFT JOIN GetUserServersCount
    ON GetUserServersCount.OwnerID = System_Users.ID;
```

### 4.2 Virtual Servers with Stacks and Domains

```sql
WITH GetVirtualServers AS (
    SELECT
        REPLACE(Names, 'hosting-users-dind-', '') AS VirtualServerID,
        OwnerID,
        Email AS OwnerEmail,
        Name,
        Status,
        State,
        Enabled
    FROM
        Hosting_DockerContainers
    LEFT JOIN Hosting_VirtualServers
        ON Hosting_VirtualServers.ID = VirtualServerID
    LEFT JOIN System_Users
        ON System_Users.ID = Hosting_VirtualServers.OwnerID
    WHERE
        ParentServerID = 0
        AND Deleted = 0
),
GetVirtualServersDomains AS (
    SELECT
        VirtualServerID,
        json_group_array(
            json_object(
                'id', ID,
                'domainname', DomainName,
                'iscloudflare', IsCloudflare,
                'ssl', SSL
            )
        ) AS DomainsJSON
    FROM
        Hosting_DomainNames
    GROUP BY VirtualServerID
)
SELECT
    json_group_array(
        json_object(
            'id',       VirtualServerID,
            'name',     Name,
            'status',   Status,
            'state',    State,
            'enabled',  Enabled,
            'domains',  JSON(DomainsJSON)
        )
    )
FROM GetVirtualServers
LEFT JOIN GetVirtualServersDomains
    ON GetVirtualServersDomains.VirtualServerID = GetVirtualServers.VirtualServerID;
```

### 4.3 Dashboard Statistics

```sql
SELECT json_object(
    'users',                 (SELECT COUNT(*) FROM System_Users),
    'virtualservers_running',(SELECT COUNT(*) FROM Hosting_VirtualServers 
                              WHERE Deleted = 0 AND ID <> 0 AND Enabled = 1),
    'virtualservers_total',  (SELECT COUNT(*) FROM Hosting_VirtualServers 
                              WHERE Deleted = 0 AND ID <> 0),
    'domains',               (SELECT COUNT(*) FROM Hosting_DomainNames)
) AS HostingSystemJSON;
```

---

## 5. Database Access Patterns

### 5.1 Connection Management

```python
import sqlite3
from contextlib import contextmanager

DATABASE_PATH = '/data/database.db'

@contextmanager
def get_db_connection():
    conn = sqlite3.connect(DATABASE_PATH, check_same_thread=False)
    conn.row_factory = sqlite3.Row
    try:
        yield conn
    finally:
        conn.close()
```

### 5.2 Usage Pattern

```python
with get_db_connection() as conn:
    # Read operation
    result = conn.execute('SELECT * FROM System_Users WHERE ID = ?', [user_id])
    user = result.fetchone()
    
    # Write operation
    conn.execute('UPDATE System_Users SET LastLogin = ? WHERE ID = ?', [timestamp, user_id])
    conn.commit()
```

---

## 6. Data Integrity

### 6.1 Constraints

| Table | Constraint | Type |
|-------|------------|------|
| System_Users | Email | UNIQUE |
| System_RegistrationCodes | UserID | UNIQUE |
| System_RegistrationCodes | Code | UNIQUE |
| Hosting_DomainNames | DomainName | UNIQUE |
| Hosting_DockerContainers | (DockerID, ParentServerID) | UNIQUE |

### 6.2 Foreign Key Relationships

SQLite foreign keys are **not enforced** by default. The application maintains referential integrity:

| Child Table | Parent Table | Relationship |
|-------------|--------------|--------------|
| System_RegistrationCodes.UserID | System_Users.ID | 1:1 |
| Hosting_VirtualServers.OwnerID | System_Users.ID | N:1 |
| Hosting_DomainNames.VirtualServerID | Hosting_VirtualServers.ID | N:1 |
| Hosting_DockerContainers.ParentServerID | Hosting_VirtualServers.ID | N:1 |
| System_RecentActivity.UserID | System_Users.ID | N:1 |

---

## 7. Maintenance Operations

### 7.1 Cleanup Stale Containers

Run automatically by background monitor:
```sql
DELETE FROM Hosting_DockerContainers 
WHERE UpdatedAt < datetime('now', '-5 minutes');
```

### 7.2 Cleanup Expired Registration Codes

Run when fetching codes:
```sql
DELETE FROM System_RegistrationCodes 
WHERE ValidUntil < strftime('%s', 'now');
```

### 7.3 Database Backup

```bash
# Stop backend container
docker stop hosting-control-backend

# Copy database file
cp _DATA/control-backend/database.db _DATA/control-backend/database.db.backup

# Restart backend container
docker start hosting-control-backend
```

---

## 8. Performance Considerations

### 8.1 SQLite Limitations

- Single writer at a time
- No concurrent write transactions
- Best for < 100 concurrent users

### 8.2 Optimization Opportunities

```sql
-- Add indexes for common queries
CREATE INDEX idx_vs_owner ON Hosting_VirtualServers(OwnerID);
CREATE INDEX idx_vs_deleted ON Hosting_VirtualServers(Deleted);
CREATE INDEX idx_dc_parent ON Hosting_DockerContainers(ParentServerID);
CREATE INDEX idx_dn_vs ON Hosting_DomainNames(VirtualServerID);
CREATE INDEX idx_ra_time ON System_RecentActivity(Time);
```

### 8.3 JSON Aggregation

SQLite JSON functions (`json_object`, `json_group_array`) are used to:
- Reduce number of queries
- Return structured data in single query
- Simplify Python code

---

## 9. Migration Considerations

### 9.1 Future PostgreSQL Migration

If scaling requires it:

| SQLite | PostgreSQL |
|--------|------------|
| `INTEGER PRIMARY KEY` | `SERIAL PRIMARY KEY` |
| `TEXT` | `VARCHAR(n)` or `TEXT` |
| `json_object()` | `jsonb_build_object()` |
| `json_group_array()` | `jsonb_agg()` |

### 9.2 Schema Versioning

Currently no formal migration system. Changes are applied manually:

```python
def init_db_tables():
    # Check if column exists, add if not
    conn.execute('''
        ALTER TABLE System_Users ADD COLUMN NewField TEXT DEFAULT ''
    ''')
```

---

## Next Document

Continue to [07-SECURITY.md](07-SECURITY.md) for security considerations and hardening.

